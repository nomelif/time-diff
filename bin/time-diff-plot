#!/usr/bin/python
import os
import sys
import select
import traceback
import locale
import matplotlib.pylab as plt
from scipy import stats
import numpy
import sys
import calendar
from math import floor, ceil
import time

ROOT_PATH = os.path.abspath(os.path.abspath(os.path.dirname(__file__)) + '/../')
TIMEDIFF_PATH = os.path.join(ROOT_PATH, 'timediff')

sys.path.append(TIMEDIFF_PATH)

import log_parser
import cli_input
import cli_output

help = """Use by piping file (or greped lines) to program.

ARGUMENTS (All are mandatory)


-h            : Show this help
-f=           : Set datetime format options, defaults to "%Y%m%d_%H%M%S" overrides given presets
-F=           : Set datetime formatting preset, defaults to none, accepted values are:

	* custom1 : "%b %d %H:%M:%S"
-l=           : Sets locale to be used with parsing month and weekday names, defaults to American English (en_US on unix, en-US on Windows).
-v            : Sets program to verbose mode, errors will be written to console.
-p            : Cancels adding zero-padding, eg. without -p 2 would become 02
--logarithmic : If set makes y-axis scale logarithmic"""
exit_code = 0
log_parser = log_parser.LogParser()
cli_in = cli_input.CliInput()
cli_out = cli_output.CliOutput()
format = "%Y%m%d_%H%M%S"
parse_logs = False
args = cli_in.get_params_dict(sys.argv)
values_dict = cli_in.parse_args_dict(args)
sys.stderr.write(values_dict["err msg"])
parse_logs = values_dict["proceed to parse"]
exit_code = values_dict["err code"]
format = values_dict["format"]

def plot_KDE(times, log=False):
	"""

Plots kernel density average of _times_. If argument _log_ is set to True, the y-axis' scale becomes logarithmic. Returns nothing.

	"""
	b = plt.figure(2)
	plt.xlabel('Time (s)', fontsize=20)
	plt.ylabel('Quantity (pcs)', fontsize=20)
	ticks = numpy.linspace(min(times), max(times), 10000)
	density = stats.kde.gaussian_kde(times)
	plt.plot(ticks, density(ticks))
	plt.grid()
	ax = plt.gca()
	if log:
		ax.set_yscale("log")
		b.suptitle('Gausssian Kernel Density Estimation (KDE)  (logarithmically scaled y-axis)', fontsize=12)
	else:
		b.suptitle('Gausssian Kernel Density Estimation (KDE)', fontsize=12)
	b.show()

def plot_histogram(times, log=False):
	"""

Plots histogram of _times_. If argument _log_ is set to True, the y-axis' scale becomes logarithmic. Returns nothing.

	"""
	a = plt.figure(1)
	plt.xlabel('Time (s)', fontsize=20)
	plt.ylabel('Quantity (pcs)', fontsize=20)
	minimum = floor(min(times))
	maximum = ceil(max(times))
	n_bins = maximum - minimum
	plt.hist(times, bins=n_bins)
	plt.grid()
	ax = plt.gca()
	if log:
		ax.set_yscale("log")
		a.suptitle('Histogram (logarithmically scaled y-axis)', fontsize=12)
	else:
		a.suptitle('Histogram', fontsize=12)
	a.show()

if parse_logs:
	log_arr = cli_in.get_log_arr(sys.stdin)
	try:
		logs = log_parser.parse_logs(log_arr, format, args["-p"])
	except:
		sys.stderr.write("Format \"{0}\" is invalid\n".format(format))
		sys.exit(1)
	times = []
	for line in logs:
		try:
			value_to_add  = line[1].total_seconds()/100
			times.append(value_to_add)
		except:
			sys.stderr.write("Line doesn't match format \"{0}\"\n".format(format))
			exit_code = 1
	logarithmic = "--logarithmic" in sys.argv
	plot_histogram(times, logarithmic)
	plot_KDE(times, logarithmic)
	plt.show()
	sys.exit(exit_code)
elif "-h" in sys.argv:
	print(help)